/*
	Copyright (c) 2004-2011, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/


if(!dojo._hasResource["drawboard.graph.GraphProxy"]){dojo._hasResource["drawboard.graph.GraphProxy"]=true;dojo.provide("drawboard.graph.GraphProxy");dojo.require("drawboard.graph.strategy.GraphStrategyFactory");dojo.require("drawboard.controller.RelationController");dojo.require("drawboard.graph.decorate.Mark");dojo.require("drawboard.Constant");dojo.require("common.calc.Geometry");dojo.require("common.exception.Exception");dojo.require("common.utils.CollectionUtils");dojo.require("drawboard.graph.strategy.RectangleStrategy");(function(){var _1=drawboard.Constant,_2=_1.Decorate,_3=drawboard.GraphStrategyFactory,_4=common.calc.Geometry,_5=_4.dividePoint,_6=_4.add2Points,_7=_4.subtract2Points,_8=_4.rotation;dojo.declare("drawboard.graph.GraphProxy",null,{_graphStatus:null,_graphStrategyClass:null,_isActive:false,_isActived:false,_isComposite:false,_showMark:false,constructor:function(_9,_a){_a=dojo.trim(_a);this._graphStrategyClass=_a;this._graphStatus=_9;},getGraphStrategy:function(){return _3.getGraphStrategy(this.getGraphStrategyClass());},getGraphStrategyClass:function(){if(!this._graphStrategyClass){new common.exception.Exception({msg:"graph proxy must have an graph strategy class!"});}return this._graphStrategyClass;},getGraphStatus:function(){if(!this._graphStatus){new common.exception.Exception({msg:"graph status proxy must have an graph status instance!"});}return this._graphStatus;},setRatio:function(_b){return this.getGraphStatus().setRatio(_b);},getRatio:function(){return this.getGraphStatus().getRatio();},setText:function(_c){this.getGraphStatus().setText(_c);},getText:function(){return this.getGraphStatus().getText();},isComposite:function(){return this._isComposite;},showMark:function(_d){if(_d!==undefined){this._showMark=_d;}return this._showMark;},getIdty:function(){return this.getGraphStatus().getIdty();},isActive:function(_e){if(_e!==null&&_e!==undefined){this._isActive=_e;}return this._isActive;},isActived:function(_f){if(_f!==null&&_f!==undefined){this._isActived=_f;}return this._isActived;},getCenter:function(_10){var _11=this.getCache(_10),_12=_11[_2.CENTER];if(!_12){var gs=this.getGraphStatus(),c=gs.getCoordinate(_10),w=gs.getWidth(_10),h=gs.getHeight(_10);_11[_2.CENTER]=_12={x:c.x+(w>>1),y:c.y+(h>>1)};}return _12;},getCoordinate:function(_13){return this.getGraphStatus().getCoordinate(_13);},setCoordinate:function(_14,_15){this.getGraphStatus().setCoordinate(_14,_15);},reset:function(_16,_17){var gs=this.getGraphStatus(),_18=gs.getMarks(_17),_19=gs.getMotionAnchors(_17);if(_18){dojo.forEach(_18,function(_1a){if(_1a){_1a.x+=_16.x;_1a.y+=_16.y;}},this);gs.setMarks(_18,_17);}if(_19&&!gs.isAffectedByZoom()){dojo.forEach(_19,function(_1b){if(_1b){_1b.x+=_16.x;_1b.y+=_16.y;}},this);gs.setMotionAnchors(_19,_17);}},getWidth:function(_1c){return this.getGraphStatus().getWidth(_1c);},setWidth:function(w,_1d){this.getGraphStatus().setWidth(w,_1d);},getHeight:function(_1e){return this.getGraphStatus().getHeight(_1e);},setHeight:function(h,_1f){this.getGraphStatus().setHeight(h,_1f);},setRotator:function(_20,_21,_22){var gs=this.getGraphStatus(),_23=gs.getRotator();(!_23)&&(_23={angle:0});if(_20.angle!=_23.angle){_23.angle=_20.angle;gs.setRotator(_23);}else{}!_22&&this.refresh(_21);},getRotator:function(_24){var gs=this.getGraphStatus(),_25=gs.getRotator(),_26=gs.getCoordinate(_24),h=gs.getHeight(_24),w=gs.getWidth(_24);return {coordinate:{x:_26.x+(w>>1),y:_26.y+(h>>1)},angle:_25?_25.angle:0};},getGraphRotator:function(_27){var gs=this.getGraphStatus(),_28=this.getGraphStrategy(),_29=gs.getRotateAngle(),_2a=this.getCenter(_27);if(!_28.hasRotator()){return {coordinate:_28.getRotatorCoordinate(this,_27)||_2a,angle:_29};}return {coordinate:_2a,angle:_29};},getRealMarks:function(_2b){return this.getGraphStatus().getMarks(_2b);},getRealMotionAnchors:function(_2c){return this.getGraphStatus().getMotionAnchors(_2c);},getUrl:function(){return this.getGraphStatus().getUrl();},getNWCoordinate:function(_2d){var _2e=this.getGraphRotator(_2d),_2f=_2e.coordinate,a=_2e.angle;return _8(this.getCoordinate(_2d),_2f,a);},getSECoordinate:function(_30){var _31=this.getGraphRotator(_30),_32=_31.coordinate,a=_31.angle,_33=this.getCoordinate(_30),w=this.getWidth(_30),h=this.getHeight(_30);return _8({x:_33.x+(w>>1),y:_33.y+(h>>1)},_32,a);},getCoordinatesByDeal:function(_34,_35){var _36=_34(this,_35);if(!_36||_36.length==0){return null;}var r=_35.getDistance(),_37=this.getGraphRotator(_35),_38=_37.coordinate,_39=common.utils.CollectionUtils.copy4Attrs,a=_37.angle,p=_36[0],_3a,_3b;_3b=_8(p,_38,a);_39(p,_3b,{x:1,y:1});_36[0]=[_3b,_8({x:p.x-r,y:p.y-r},_38,a),_8({x:p.x+r,y:p.y-r},_38,a),_8({x:p.x+r,y:p.y+r},_38,a),_8({x:p.x-r,y:p.y+r},_38,a)];dojo.forEach(_36,function(_3c,_3d){if(_3d!=0){_3b=_8(_3c,_38,a);_39(_3c,_3b,{x:1,y:1});_3a=_7(_3b,_36[0][0]);_36[_3d]=[_3b,_6(_36[0][1],_3a),_6(_36[0][2],_3a),_6(_36[0][3],_3a),_6(_36[0][4],_3a)];}},this);return _36;},getGraphCoordinates:function(_3e){var _3f=this.getCache(_3e),_40=_3f[_2.Graph];if(!_40){var _41=this.getGraphStrategy(),_42=this.getGraphRotator(_3e),_43=_42.coordinate,a=_42.angle,_44=_41.getGraphCoordinates(this,_3e);dojo.forEach(_44,function(_45,_46){_44[_46]=_8(_45,_43,a);},this);_3f[_2.Graph]=_44;return _44;}return _40;},getSkeletonCoordinates:function(_47){var _48=this.getCache(_47),_49=_48[_2.SKELETON];if(!_49){var _4a=this.getGraphStrategy(),_4b=this.getCoordinatesByDeal(_4a.getSkeletonCoordinates,_47);_48[_2.SKELETON]=_4b;return _4b;}return _49;},getMarkCoordinates:function(_4c){var _4d=this.getCache(_4c),_4e=_4d[_2.MARK];if(!_4e){var _4f=this.getGraphStrategy(),_50=this.getCoordinatesByDeal(_4f.getMarkCoordinates,_4c);_4d[_2.MARK]=_50;return _50;}return _4e;},getOutletCoordinates:function(_51){var _52=this.getCache(_51),_53=_52[_2.OUTLET];if(!_53){var _54=new drawboard.graph.strategy.RectangleStrategy(),_55=_54.getGraphCoordinates(this,_51),_56=this.getGraphRotator(_51),_57=_56.coordinate,a=_56.angle;dojo.forEach(_55,function(_58,_59){_55[_59]=_8(_58,_57,a);},this);_52[_2.OUTLET]=_55;return _55;}return _53;},hasRotator:function(){return this.getGraphStrategy().hasRotator();},getRotatorCoordinates:function(_5a){if(!this.hasRotator()){return null;}var _5b=this.getCache(_5a),_5c=_5b[_2.ROTATOR];if(!_5c){var r=_5a.getDistance(),d=_5a.getRotateDistance(),_5d=this.getRotator(_5a),_5e=_5d.coordinate,a=_5d.angle,_5f=this.getCoordinate(_5a),_60={x:_5e.x,y:_5f.y},_61=this.getGraphRotator(_5a).coordinate,_62=_4.getDistant(_5e,_8(_60,_61,a)),_63;(_62>0)&&(d+=_62);_63=_8({x:_5e.x,y:_5e.y-d-r},_5e,a);_5c=[_4.intersectCircleLine(_63,r,_63,{x:_63.x,y:_63.y+10})[0],_8({x:_5e.x,y:_5e.y-d},_5e,a),_8({x:_5e.x,y:_5e.y-r},_5e,a),{x:_5e.x,y:_5e.y},_8({x:_5e.x,y:_5e.y-2*r},_5e,a),_63];_5b[_2.ROTATOR]=_5c;return _5c;}return _5c;},getMotionAnchorCoordinates:function(_64){var _65=this.getCache(_64),_66=_65[_2.MOTIONANCHOR];if(!_66){var _67=this.getGraphStrategy(),_68=this.getCoordinatesByDeal(_67.getMotionAnchorCoordinates,_64);_65[_2.MOTIONANCHOR]=_68;return _68;}return _66;},refresh:function(_69,_6a){var _6b=this.getMarkCoordinates(_69),_6c,_6d;this.clearCache(_69);this.getSkeletonCoordinates(_69);this.getMotionAnchorCoordinates(_69);_6c=this.getMarkCoordinates(_69);dojo.forEach(_6b,function(_6e,_6f){if(_6e[0]!=_6c[_6f][0]){_6d=_7(_6c[_6f][0],_6e[0]);drawboard.relationController.fireEvent(this.getIdty(),new drawboard.graph.decorate.Mark({coordinate:[_6e[1],_6e[3],_6e[2],_6e[4]],index:_6f}),[_6d],_69,_6a);}},this);},getCache:function(_70){return _70.getCache(this);},clearCache:function(_71,_72){_71.clearCache(this,_72);},draw:function(_73){var _74=this.getGraphStrategy().draw(this,_73.getGraphic(),_73);_74.setAttribute("id",this.getIdty());if(this.isActived()){var p=drawboard.Constant.Path,_75=this.getOutletCoordinates(_73);_73.getGraphic().drawPath([{command:p.MOVE,points:_75[0]},{command:p.LINE,points:_75[1]},{command:p.LINE,points:_75[2]},{command:p.LINE,points:_75[3]},{command:p.LINE,points:_75[0]}],"fill:none;stroke:red;stroke-width:2");}},sizeChange:function(_76,_77,end,_78){var _79=this.getGraphStrategy(),_7a=this.getGraphRotator(_78),_7b=_7a.coordinate,a=_7a.angle,_7c=_77,gp=this,_7d=_79.hasRotator(),_7e={};if(end!==null&&end!==undefined){_7c=_7(end,_77);if(_7d){var _7f=_76.getDirect(),d=_1.Direction,_80=this.getCoordinate(_78),_81=this.getSkeletonCoordinates(_78),_82,_83;switch(_7f){case d.NORTH:case d.WEST:case d.WESTNORTH:_82=_81[3][0];_83=function(pos,p,a){gp.setCoordinate(_6(_80,_7(_8(pos,p,-a),{x:_80.x+gp.getWidth(_78),y:_80.y+gp.getHeight(_78)})),_78);};break;case d.EASTNORTH:_82=_81[2][0];_83=function(pos,p,a){gp.setCoordinate(_6(_80,_7(_8(pos,p,-a),{x:_80.x,y:_80.y+gp.getHeight(_78)})),_78);};break;case d.WESTSOUTH:_82=_81[1][0];_83=function(pos,p,a){gp.setCoordinate(_6(_80,_7(_8(pos,p,-a),{x:_80.x+gp.getWidth(_78),y:_80.y})),_78);};break;case d.SOUTH:case d.EAST:case d.EASTSOUTH:_82=_81[0][0];_83=function(pos,p,a){pos=_8(pos,p,-a);gp.setCoordinate(pos,_78);};break;case d.END:break;default:break;}_7e.oriFixPos=_82;_7e.oriFixFunct=_83;_77=_8(_77,_7b,-a);end=_8(end,_7b,-a);_7c=_7(end,_77);}}_79.sizeChange(this,_76,_7c,_78);if(_7d&&a!=0&&_7e!==undefined){this.clearCache(_78,_2.CENTER);var _84=_8(this.getCenter(_78),_7b,a);_7e.oriFixFunct(_7e.oriFixPos,_84,a);}this.refresh(_78);},normalize:function(_85,_86){var _87=this.getGraphStrategy().normalize(this,_85,_86);_87&&this.refresh(_86);},move:function(_88,end,_89){var _8a=this.getCoordinate(_89),_8b=_7(end,_88);this.setCoordinate({x:_8a.x+_8b.x,y:_8a.y+_8b.y},_89);this.reset(_8b,_89);this.refresh(_89);},zoom:function(_8c,_8d){this.refresh(_8d,function(){return false;});},moveMotionAnchor:function(_8e,_8f,_90){var _91=this.getGraphStrategy().calcMotionAnchor(this,_8e,_8f,_90),_92=this.getRealMotionAnchors(_90);_92&&(_8e.getIndex()<_92.length)&&(_91!=null)&&(_92[_8e.getIndex()]=_91);this.refresh(_90);},active:function(p,_93){if(this.getGraphStrategy().isIn(this,p,_93)){return this;}return null;},getActiveAnchors:function(_94){return this.getGraphStrategy().getActiveAnchors(this,_94);},isAnchor:function(d){return this.getGraphStrategy().isAnchor(d);},deleteAll:function(db,_95){this.destroy(_95);},destroy:function(_96){drawboard.relationController.removeListener(this,null,_96);}});})();}