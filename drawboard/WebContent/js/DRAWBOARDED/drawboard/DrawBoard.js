/*
	Copyright (c) 2004-2011, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/


if(!dojo._hasResource["drawboard.DrawBoard"]){dojo._hasResource["drawboard.DrawBoard"]=true;dojo.provide("drawboard.DrawBoard");dojo.require("drawboard.PreRequire");dojo.require("drawboard._Event");dojo.require("drawboard._Selector");dojo.require("drawboard.graphic.SVGGraphic");dojo.require("drawboard.board.TextBoard");dojo.require("drawboard.graph.GraphProxy");dojo.require("drawboard.controller.StyleController");dojo.require("drawboard.controller.ParamsController");dojo.require("drawboard.drawProcessor.DbDrawProcessor");dojo.require("drawboard.context.ExecuteContext");dojo.require("drawboard.runtime.ExecuteRuntime");dojo.require("drawboard.command.CompositeCommand");dojo.require("drawboard.controller.CommandController");dojo.require("common.calc.Geometry");dojo.require("common.listener.Listener");dojo.require("dijit._Widget");dojo.require("dijit._Templated");dojo.declare("drawboard.DrawBoard",[dijit._Templated,drawboard._Selector,drawboard._Event,common.listener.Listener],{templateString:"<div></div>",dbCanvas:null,graphicClass:drawboard.graphic.SVGGraphic,textBoardClass:drawboard.board.TextBoard,_textBoard:null,_graphic:null,w:null,h:null,defaultWidth:300,defaultHeight:300,_selectRect:null,_runtime:null,fixNode:null,SRGraphStrategyClass:"drawboard.graph.strategy.RectangleStrategy",graphStrategyParam:null,drawEntity:null,_commands:null,postCreate:function(){var _1=this.createGraphic(),_2,_3=drawboard.controller,_4,_5,w=this.w,h=this.h,_6=this.domNode.style;_5=dojo.create("div",{},this.domNode);_6.overflow="auto";_6.width=w+"px";_6.height=h+"px";_6.position="relative";this.dbCanvas=_5;_2=_1.createAnchor(w||this.defaultWidth,h||this.defaultHeight,_5);_4=new drawboard.context.ExecuteContext({paramsCtrl:new _3.ParamsController(),styleCtrl:new _3.StyleController(),commandCtrl:new _3.CommandController(),drawProcessor:new drawboard.drawProcessor.DbDrawProcessor()});this._textBoard=new this.textBoardClass({"_db":this});this.domNode.appendChild(this._textBoard.domNode);this._runtime=new drawboard.runtime.ExecuteRuntime({context:_4,graphic:_1});drawboard.DrawBoard.superclass.postCreate.call(this,this.domNode);},ready:function(){return this.getGraphic().ready();},getTextBoard:function(){return this._textBoard;},getGraphic:function(){return this.getRuntime().getGraphic();},getRuntime:function(){return this._runtime;},setRuntime:function(_7){this._runtime=_7;},setGraphStrategyParam:function(_8){this.graphStrategyParam=_8;},getGraphStrategyParam:function(){return this.graphStrategyParam;},createGraphic:function(){if(!this._graphic){this._graphic=new this.graphicClass();}return this._graphic;},getDrawEntity:function(_9){if(!this.drawEntity&&_9){this.drawEntity={};}return this.drawEntity;},getCanvasSize:function(){var _a=this.getRuntime().getContext().getZoom();return {x:this.w*_a.x,y:this.h*_a.y};},getUserViewSize:function(){var _b=this.domNode;return {x:_b.clientWidth,y:_b.clientHeight};},clearDrawEntity:function(_c){var _d=this.drawEntity,_e=this.graphStrategyParam;if(_d&&!_c){var gs=new drawboard.graph.GraphStatus({_coordinate:{x:_d.x,y:_d.y},_w:_d.width,_h:_d.height,affectedByZoom:(_e&&_e.affectedByZoom)}),gp=new drawboard.graph.GraphProxy(gs,this.getDrawType());_e&&_e.url&&(gs.setUrl(_e.url));_e&&_e.ratio&&(gs.setRatio(_e.ratio));this.addCommand(drawboard.Constant.Command.CREATEVSDELETECOMMAND,this,gp);}this.drawEntity=null;this.graphStrategyParam=null;},getSRGraphStrategyClass:function(){return this.SRGraphStrategyClass;},setSRGraphStrategyClass:function(_f){this.SRGraphStrategyClass=_f;},getSelectRect:function(){return this._selectRect;},setSelectRect:function(_10){var _11=this._selectRect;if(_10==_11){return;}_11&&_11.destroy();this._selectRect=_10;},containsSelectRect:function(_12){var _13=false;this.some(function(gp){if(gp.isComposite()&&gp.equals(_12)){_13=true;return true;}},this);return _13;},combine:function(){var _14=this.getSelectRect();_14&&!this.containsSelectRect(_14)&&!_14.resetRelations()&&this.combineGraph(_14);this._selectRect=null;},combineGraph:function(gp){this.add(gp);},divide:function(){var gp=this.getActive();this.divideGraph(gp);},divideGraph:function(gp){if(gp&&gp.isComposite()){gp.destroy();this.remove(gp);}},addGraph:function(gs,_15){var _16=new drawboard.graph.GraphProxy(gs,_15);this.add(_16);},removeGraph:function(gp){gp.deleteAll(this,this.getRuntime());this.getRuntime().getContext().getStyleCtrl().removeGraph(gp);this.remove(gp);},getGraph:function(_17){var gs;this.some(function(_18){if(_18.getIdty()==_17){gs=_18;return true;}});return gs;},zoom:function(_19,_1a){var _1b=dojo.clone(_1a.getContext().getZoom());if(!_1a.getContext().setZoom(_19)){return;}var _1c=_1a.getContext().getZoom(),_1d=this.dbCanvas.style,gf=this.getGraphic(),w=this.w*_1c.x,h=this.h*_1c.y,_1e=this.domNode,_1f=common.calc.Geometry,_20=this.getSelectRect(),_21;_21={x:_1e.scrollLeft+(this.w>>1),y:_1e.scrollTop+(this.h>>1)};_21=_1f.dividePoint(_21,_1b)[0];_21=_1f.multiPoint(_21,_1c)[0];_1d.width=w+"px";_1d.height=h+"px";_1e.scrollLeft=_21.x-(this.w>>1);_1e.scrollTop=_21.y-(this.h>>1);gf.setSize(w,h);this.forInItems(function(gp){gp&&_1a.zoom(gp,_1c);},this,true);_20&&_1a.zoom(_20,_1c);this.fireListener(["zoom",[_19]]);},draw:function(){this.clearGraphs();var _22=this.getSelectRect(),_23=this.getDrawEntity(),_24=this.getRuntime();if(_23){var gs=new drawboard.graph.GraphStatus({_coordinate:{x:_23.x,y:_23.y},_w:_23.width,_h:_23.height}),_25=new drawboard.graph.GraphProxy(gs,this.getDrawType()||this.getSRGraphStrategyClass()),_26=this.graphStrategyParam;_26&&_26.url&&(gs.setUrl(_26.url));_26&&_26.ratio&&(gs.setRatio(_26.ratio));_25.showMark(false);_24.draw(_25);}_22&&(_24.draw(_22));this.drawGraphs(_24);this.fireListener(["draw"]);},drawGraphs:function(_27){this.forInItems(function(gp){gp&&_27.draw(gp);},this);},clearGraphs:function(){this.getGraphic().clear();},setStyle:function(_28,_29,_2a){var gp=this.getActive();if(_2a&&gp&&!gp.getText()){return;}gp&&this.addCommand(drawboard.Constant.Command.STYLECOMMAND,this.getRuntime().getContext().getStyleCtrl(),{gp:gp,attr:_28,value:_29,isText:_2a});this.clearCommand();this.draw();},setText:function(_2b){this.last().setText(_2b);},getCommandCtrl:function(){return this.getRuntime().getContext().getCommandCtrl();},getCommands:function(){var _2c=this._commands;if(!_2c){_2c=this._commands=new drawboard.command.CompositeCommand();this.getCommandCtrl().add(_2c);}return _2c;},addCommand:function(_2d,_2e,_2f,_30){var _31=this.getCommandCtrl().instanceCommand(_2d,_2e,_2f,_30,this.getRuntime());_31.execute();this.getCommands().add(_31);},clearCommand:function(){this._commands=null;},undo:function(){this.getCommandCtrl().undo();this.draw();},redo:function(){this.getCommandCtrl().redo();this.draw();}});}