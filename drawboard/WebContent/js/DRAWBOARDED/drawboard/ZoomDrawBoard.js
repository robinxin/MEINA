/*
	Copyright (c) 2004-2011, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/


if(!dojo._hasResource["drawboard.ZoomDrawBoard"]){dojo._hasResource["drawboard.ZoomDrawBoard"]=true;dojo.provide("drawboard.ZoomDrawBoard");dojo.require("drawboard.graphic.SVGGraphic");dojo.require("drawboard.graph.GraphProxy");dojo.require("drawboard.controller.StyleController");dojo.require("drawboard.controller.ParamsController");dojo.require("drawboard.drawProcessor.ZoomDrawProcessor");dojo.require("drawboard.context.ExecuteContext");dojo.require("drawboard.runtime.ExecuteRuntime");dojo.require("common.exception.Exception");dojo.require("common.calc.Geometry");dojo.require("dijit._Widget");dojo.require("dijit._Templated");(function(){var _1=common.calc.Geometry,_2=drawboard.Constant.MouseAction,_3=_1.subtract2Points;dojo.declare("drawboard.ZoomDrawBoard",[dijit._Widget,dijit._Templated],{templateString:"<div style='position:relative;overflow:hidden;'><div dojoAttachPoint='zoomDrawboard'></div><div dojoAttachPoint='zoomRect' style='position:absolute;border:2px solid red;left:0px;top:0px;'></div></div>",graphicClass:drawboard.graphic.SVGGraphic,_graphic:null,anchor:null,w:null,h:null,_zoom:{x:100,y:100},rectBorder:2,defaultWidth:300,defaultHeight:300,_runtime:null,drawboard:null,events:null,boxCache:null,scopeSelf:false,postCreate:function(){var _4=this.createGraphic(),_5,_6=drawboard.controller,_7,db=this.getDrawBoard(),_8,_9=this.zoomRect,_a=this.domNode,_b=this.rectBorder,w=this.w||this.defaultWidth,h=this.h||this.defaultHeight;_5=_4.createAnchor(w,h);this.anchor=_5;_7=new drawboard.context.ExecuteContext({paramsCtrl:new _6.ParamsController(),styleCtrl:new _6.StyleController(),drawProcessor:new drawboard.drawProcessor.ZoomDrawProcessor(),zoom:{x:50,y:50}});this._runtime=_8=new drawboard.runtime.ExecuteRuntime({context:_7,graphic:_4});this.zoomDrawboard.appendChild(this.anchor);_9.style.width=w+"px";_9.style.height=h+"px";_a.style.width=w+(_b<<1)+"px";_a.style.height=h+(_b<<1)+"px";this.events=[dojo.connect(_9,"onmousemove",dojo.hitch(this,"doMouseMove")),dojo.connect(_9,"onmousedown",dojo.hitch(this,"doMouseDown")),dojo.connect(_9,"onmouseup",dojo.hitch(this,"doMouseUp"))];db.addListener(this.apply,this);db.getRuntime().addListener(_8.apply,_8);},getDrawBoard:function(){if(!this.drawboard){new common.exception.Exception({msg:"the draw board can't find in the zoom window!"});}return this.drawboard;},setDrawBoard:function(_c){this.drawboard=_c;},setZoom:function(_d){var _e=_3(this._zoom,{x:_d.x,y:_d.y});if(_e.x<0||_e.y<0||_e.x>200||_e.y>200){return false;}this._zoom=_e;return true;},getZoom:function(){return _1.dividePoint(this._zoom,{x:100,y:100})[0];},getGraphic:function(){return this.getRuntime().getGraphic();},getRuntime:function(){return this._runtime;},setRuntime:function(_f){this._runtime=_f;},createGraphic:function(){return new this.graphicClass();},apply:function(_10,_11){this[_10]&&this[_10].apply(this,_11);},zoom:function(_12){this._unitCache=null;if(!this.setZoom(_12)){return;}this.scopeSelf=true;var _13=this.zoomRect,_14=this.getDrawBoard().getRuntime().getContext().getZoom(),_15=_13.style,w=this.w,h=this.h,rw=w/(_14.x),rh=h/(_14.y);_15.left=parseFloat(_15.left)+(parseFloat(_15.width)>>1)-(rw>>1)+"px";_15.top=parseFloat(_15.top)+(parseFloat(_15.height)>>1)-(rh>>1)+"px";_15.width=rw+"px";_15.height=rh+"px";this.draw();},draw:function(){this.clearGraphs();var db=this.getDrawBoard();db.drawGraphs(this.getRuntime());},clearGraphs:function(){var _16=this.anchor;while(_16.lastChild){_16.removeChild(_16.lastChild);}},getBoxCache:function(){if(!this.boxCache){var _17=this.domNode,_18={left:_17.offsetLeft,top:_17.offsetTop};this.boxCache=_18;}return this.boxCache;},fetchCoordinate:function(e){var box=this.getBoxCache(),_19=this.domNode;return {x:e.pageX-box.left+_19.scrollLeft,y:e.pageY-box.top+_19.scrollTop};},getUnitPx:function(){if(!this._unitCache){var db=this.getDrawBoard(),_1a=db.getCanvasSize(),_1b=db.getUserViewSize(),_1c=this.zoomRect.style;this._unitCache={x:(_1a.x-_1b.x)/(this.w-parseFloat(_1c.width)),y:(_1a.y-_1b.y)/(this.h-parseFloat(_1c.height))};}return this._unitCache;},status:_2.NONE,_start:null,_end:null,_loseAccuracyLeft:0,_loseAccuracyTop:0,_accuracy:100000,doMouseMove:function(e){if(this.status!=_2.MOUSEDOWN&&this.status!=_2.MOUSEMOVE){return;}var end=this.fetchCoordinate(e),_1d=_3(end,this._start),_1e=this.zoomRect.style,db=this.getDrawBoard(),_1f=db.domNode,_20=this.getUnitPx(),_21,_22=this._accuracy,top=parseFloat(_1e.top)+_1d.y,_23=parseFloat(_1e.left)+_1d.x,_24=db.getCanvasSize(),_25=db.getUserViewSize(),_26=parseFloat(_1e.width),_27=parseFloat(_1e.height);this._start=end;(top<0)&&(top=0);(_23<0)&&(_23=0);this.scopeSelf=true;_1e.top=top+"px";_1e.left=_23+"px";if(_23==0){_1f.scrollLeft=0;this._loseAccuracyLeft=0;}else{if((_23+_26)>this.w){_1f.scrollLeft=_24.x-_25.x;_1e.left=this.w-_26+"px";}else{_1f.scrollLeft=_21=_1f.scrollLeft+_1d.x*_20.x;_21=(_21*_22-parseInt(_21)*_22)/_22;this._loseAccuracyLeft=_21=this._loseAccuracyLeft+_21;if(_21>=1){_1f.scrollLeft+=1;this._loseAccuracyLeft=_21-1;}}}if(top==0){_1f.scrollTop=0;this._loseAccuracyTop=0;}else{if((top+_27)>this.h){_1f.scrollTop=_24.y-_25.y;_1e.top=this.h-_27+"px";}else{_1f.scrollTop=_21=_1f.scrollTop+_1d.y*_20.y;_21=(_21*_22-parseInt(_21)*_22)/_22;this._loseAccuracyTop=_21=this._loseAccuracyTop+_21;if(_21>=1){_1f.scrollTop+=1;this._loseAccuracyTop=_21-1;}}}this.status=_2.MOUSEMOVE;},doMouseDown:function(e){this._start=this.fetchCoordinate(e);this.status=_2.MOUSEDOWN;},doMouseUp:function(e){this.status=_2.MOUSEUP;},doScroll:function(_28,_29){if(this.scopeSelf){this.scopeSelf=false;return;}var _2a=this.zoomRect.style,_2b=this.getUnitPx();if(_28){_2a.left=parseFloat(_2a.left)+_29/_2b.x+"px";}else{_2a.top=parseFloat(_2a.top)+_29/_2b.y+"px";}},destroy:function(){dojo.forEach(this.events,dojo.disconnect);}});})();}