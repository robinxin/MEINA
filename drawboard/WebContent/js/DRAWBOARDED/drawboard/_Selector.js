/*
	Copyright (c) 2004-2011, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/


if(!dojo._hasResource["drawboard._Selector"]){dojo._hasResource["drawboard._Selector"]=true;dojo.provide("drawboard._Selector");dojo.require("drawboard.container.LayoutContainer");dojo.require("drawboard.graph.CompositeProxy");dojo.require("drawboard.graph.GraphStatus");dojo.require("drawboard.Constant");dojo.require("drawboard.drawProcessor.DrawProcessor");(function(){var _1=drawboard.Constant,_2=_1.ActionStatus,_3=_1.MouseAction,_4=common.calc.Geometry;dojo.declare("drawboard._Selector",drawboard.container.LayoutContainer,{_events:null,_status:_2.NONE,_mouseStatus:_3.NONE,_active:null,_decorate:null,_graphStrategy:null,_isMark:false,_isSelecting:false,lastScrollTop:0,lastScrollLeft:0,cache:null,postCreate:function(_5){this._events=[dojo.connect(_5,"onmousemove",dojo.hitch(this,"doMouseMove")),dojo.connect(_5,"onmousedown",dojo.hitch(this,"doMouseDown")),dojo.connect(_5,"onmouseup",dojo.hitch(this,"doMouseUp")),dojo.connect(_5,"onmouseover",dojo.hitch(this,"doMouseOver")),dojo.connect(_5,"onclick",dojo.hitch(this,"doClick")),dojo.connect(_5,"ondblclick",dojo.hitch(this,"doDblClick")),dojo.connect(window,"onkeydown",dojo.hitch(this,"doKeyDown")),dojo.connect(window,"onkeyup",dojo.hitch(this,"doKeyUp")),dojo.connect(this.domNode,"onscroll",dojo.hitch(this,"doScroll"))];},getStatusCache:function(){if(!this.cache){this.cache={};}return this.cache;},setStatusCache:function(gp,_6,_7){var _8=this.getStatusCache();gp&&(_8.active=gp);_6&&(_8.decorate=_6);_8.status=_7;},setStatus:function(gp,_9,_a){var _b=this._active,_c;if(_b&&_b!=gp){_c=_b.getParent&&_b.getParent();if(_b.isComposite()&&!_b.contains(gp)){_b.isFocus(false);}_b.isActive(false);if(_c&&!_c.contains(gp)){_c.isFocus(false);_c.isActive(false);}}this._active=gp;this._decorate=_9;this._status=_a;this.updateActive();},updateActive:function(){var gp=this.getActive();gp&&gp.isActive(true)&&gp.isComposite()&&gp.isFocus(true);},getMouseStatus:function(){return this._mouseStatus;},setMouseStatus:function(_d){this._mouseStatus=_d;},getActionStatus:function(){return this._status;},setActionStatus:function(_e){this._status=_e;},getDecorate:function(){return this._decorate;},setDecorate:function(d){this._decorate=d;},getActive:function(){return this._active;},setActive:function(gp){this._active=gp;},setDrawType:function(_f){this._graphStrategy=_f;this._isSelecting=false;this._isMark=false;},getDrawType:function(){return this._graphStrategy;},isSelecting:function(_10){this._isSelecting=_10;if(_10){this._isMark=false;this._graphStrategy=null;}},isMark:function(_11){this._isMark=_11;if(_11){this._isSelecting=false;this._graphStrategy=null;}},doClick:function(e){this.setMouseStatus(_3.MOUSECLICK);},doDblClick:function(e){var _12=this.getActive(),_13=_12&&_12.getText(),_14=this.getTextBoard();if(_13){_14.setText(_13);_14.show(_12);}},doMouseMove:function(e){if(this.getMouseStatus()==_3.MOUSEDOWN){var _15=this.getActive(),_16=this.getStatusCache(),_17=_16.active,_18=_17&&_17.getParent&&_17.getParent(),_19=drawboard.relationController,_1a=this.getDecorate(),_1b=this.getRuntime();if(_17&&_17.isComposite()&&_15){!_15.isActive(false)&&_15.isComposite()&&_15.isFocus(false);_17.isActive(true);_17.isFocus(true);_18&&_18.isFocus(true);this._active=_17;}}this.setMouseStatus(_3.MOUSEMOVE);},doMouseDown:function(e){this.getTextBoard().hide();var d=drawboard,_1c=d.markController,_1d=this.fetchCoordinate(e),_1e,_1f=this.getRuntime(),_20=dojo.hitch(_1f.getDrawProcessor(),"setActive"),_21=this.getSelectRect(),_22=this.getActive(),_23=this.getg;status=this._status,_23=_1f.getGraphic();target=e.target;this.setMouseStatus(_3.MOUSEDOWN);if(status&&status==_2.TEXT){return;}if(this._graphStrategy){this.setStatus(null,null,_2.DRAWING);return;}_21&&(_1e=_20(_21,_1d,this._isMark,_1c,_1f));if(!_1e&&_23.isGraphMark(target.tagName)){_22&&(_1e=_20(_22,_1d,this._isMark,_1c,_1f));(!_1e)&&(_24=target.getAttribute("id"))&&this.some(function(gp){gp.getIdty()==_24&&(_1e={active:gp,decorate:null,status:_2.MOVING});if(_1e){return true;}},this,true);var _24;}if(!_1e){_22&&(_1e=_20(_22,_1d,this._isMark,_1c,_1f));(!_1e)&&this.some(function(gp){_1e=_20(gp,_1d,this._isMark,_1c,_1f);if(_1e){return true;}},this,true);}if(this.getActive()&&e.ctrlKey&&_1e&&_1e.active){_1e=_1e.active;if(_21){if(_21.contains(_1e)){return;}_21.add(_1e,_1f);}else{var _22=this.getActive();if(!_22){return;}if(_22.isComposite()&&_22.contains(_1e)){return;}var _25=_4.getMaxRect([_1e.getGraphCoordinates(_1f).concat(_22.getGraphCoordinates(_1f))]),_21=new drawboard.graph.CompositeProxy(new drawboard.graph.GraphStatus({_coordinate:{x:_25.x,y:_25.y},_w:_25.width,_h:_25.height}),this.getSRGraphStrategyClass());_22.isActive(false);_21.add(_22,_1f);_21.add(_1e,_1f);this.setSelectRect(_21);this.setStatus(_21,null,_2.MOVING);}this.draw();return;}if(_21){if(!_1e){this.setSelectRect(null);this.draw();return;}this.setStatus(_1e.active,_1e.decorate,_1e.status);return;}if(!_1e){this.setStatus(null,null,_2.SELECTING);}else{this.setStatus(_1e.active,_1e.decorate,_1e.status);}},doMouseOver:function(e){this.setMouseStatus(_3.MOUSEOVER);},doMouseUp:function(e){this.setMouseStatus(_3.MOUSEUP);this.setStatusCache(this._active,this._decorate,this._status);this._status=_2.NONE;this._decorate=null;},doKeyDown:function(e){var gp=this.getActive(),_26=this.getSelectRect(),_27=dojo.keys,_28=_1.Command,_29=dojo.hitch(this,"addCommand"),_2a=false;if(gp&&e.keyCode==_27.DELETE&&!e.ctrlKey){_29(_28.CREATEVSDELETECOMMAND,this,gp,true);_26&&this.setSelectRect(null);_2a=true;}if(e.keyCode==_27.UP_ARROW){_29(_28.ZOOMCOMMAND,this,{x:10,y:10});_2a=true;}if(e.keyCode==_27.DOWN_ARROW){_29(_28.ZOOMCOMMAND,this,{x:-10,y:-10});_2a=true;}if(e.keyCode==90&&e.ctrlKey){this.undo();_2a=true;}if(e.keyCode==89&&e.ctrlKey){this.redo();_2a=true;}_2a&&this.draw();},doKeyUp:function(e){this.clearCommand();},doScroll:function(e){var _2b=e.target||e.srcElement;if(_2b!=this.domNode){return;}var top=_2b.scrollTop,_2c=_2b.scrollLeft,_2d=this.lastScrollTop,_2e=this.lastScrollLeft;if(top!=_2d){this.fireListener(["doScroll",[false,top-_2d]]);this.lastScrollTop=top;return;}if(_2c!=_2e){this.fireListener(["doScroll",[true,_2c-_2e]]);this.lastScrollLeft=_2c;}},destroy:function(){dojo.forEach(this.events,dojo.disconnect);}});})();}